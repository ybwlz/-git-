<!DOCTYPE html>
<html lang="zh-CN">
<head>
    {% load static %}
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>今日练琴 - 苗韵琴行管理系统</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- 自定义CSS -->
    <link rel="stylesheet" href="../static/css/student.css">
    <link rel="stylesheet" href="../static/css/skin/default/layer.css">
    <style>
        :root {
            --primary-color: #6c5ce7;
            --secondary-color: #a29bfe;
            --accent-color: #fd79a8;
            --light-color: #f8f9fa;
            --dark-color: #343a40;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fb;
        }
        
        .sidebar {
            background: linear-gradient(to bottom, var(--primary-color), var(--secondary-color));
            color: white;
            height: 100vh;
            position: fixed;
            padding-top: 20px;
        }
        
        .sidebar .nav-link {
            color: rgba(255, 255, 255, 0.85);
            border-radius: 5px;
            margin: 5px 10px;
            transition: all 0.3s;
        }
        
        .sidebar .nav-link:hover, .sidebar .nav-link.active {
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
        }
        
        .sidebar .nav-link i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }
        
        .main-content {
            margin-left: 250px;
            padding: 20px;
        }
        
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
                padding-top: 0;
            }
            
            .main-content {
                margin-left: 0;
            }
        }
        
        .practice-card {
            background-color: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }
        
        .practice-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .practice-header h2 {
            color: var(--primary-color);
            font-weight: 600;
            margin-bottom: 10px;
        }
        
        .practice-header p {
            color: #777;
            font-size: 16px;
        }
        
        .practice-status {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .practice-status.inactive {
            background: linear-gradient(135deg, #6c757d, #495057);
        }
        
        .practice-status.active {
            background: linear-gradient(135deg, #20bf6b, #0fb9b1);
        }
        
        .status-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }
        
        .status-text {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 10px;
        }
        
        .status-desc {
            font-size: 16px;
            opacity: 0.9;
        }
        
        .timer-container {
            text-align: center;
            margin: 30px 0;
        }
        
        .timer {
            font-size: 48px;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 10px;
        }
        
        .timer-label {
            font-size: 16px;
            color: #777;
        }
        
        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 30px 0;
        }
        
        .btn-action {
            padding: 12px 30px;
            font-size: 16px;
            font-weight: 600;
            border-radius: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }
        
        .btn-action i {
            margin-right: 10px;
            font-size: 18px;
        }
        
        .btn-checkin {
            background-color: var(--primary-color);
            border: none;
        }
        
        .btn-checkin:hover {
            background-color: #5649c0;
            transform: translateY(-2px);
        }
        
        .btn-checkout {
            background-color: #e74c3c;
            border: none;
        }
        
        .btn-checkout:hover {
            background-color: #c0392b;
            transform: translateY(-2px);
        }
        
        .btn-scan {
            background-color: #2ecc71;
            border: none;
        }
        
        .btn-scan:hover {
            background-color: #27ae60;
            transform: translateY(-2px);
        }
        
        .piano-info {
            background-color: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 30px;
        }
        
        .piano-info h4 {
            color: var(--primary-color);
            font-weight: 600;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }
        
        .piano-info h4 i {
            margin-right: 10px;
        }
        
        .piano-details {
            display: flex;
            flex-wrap: wrap;
        }
        
        .piano-detail-item {
            flex: 1;
            min-width: 200px;
            margin-bottom: 15px;
        }
        
        .piano-detail-label {
            font-size: 14px;
            color: #777;
            margin-bottom: 5px;
        }
        
        .piano-detail-value {
            font-size: 16px;
            font-weight: 500;
        }
        
        .qr-scanner {
            display: none;
            margin: 20px auto;
            max-width: 400px;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .qr-scanner video {
            width: 100%;
            height: auto;
        }
        
        .qr-scanner-overlay {
            position: relative;
        }
        
        .qr-scanner-frame {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border: 2px solid var(--primary-color);
            border-radius: 10px;
            pointer-events: none;
        }
        
        .qr-scanner-controls {
            display: flex;
            justify-content: center;
            margin-top: 15px;
        }
        
        .waiting-info {
            background-color: #fff3cd;
            color: #856404;
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            text-align: center;
            display: none;
        }
        
        .waiting-info i {
            font-size: 24px;
            margin-right: 10px;
        }
        
        .waiting-time {
            font-weight: 600;
            font-size: 18px;
        }
    </style>
</head>
<body>
    <!-- 侧边栏 -->
    <div class="sidebar col-md-3 col-lg-2 d-md-block">
        <div class="text-center mb-4">
            <img src="../static/img/logo.jpg" alt="苗韵琴行" class="img-fluid rounded-circle" style="width: 80px; height: 80px; object-fit: cover; border: 3px solid rgba(255, 255, 255, 0.3);">
            <h5 class="mt-2">苗韵琴行</h5>
        </div>
        <ul class="nav flex-column">
            <li class="nav-item">
                <a class="nav-link" href="student_profile.html">
                    <i class="fas fa-user"></i> 个人主页
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link active" href="student_practice.html">
                    <i class="fas fa-music"></i> 今日练琴
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="student_attendance.html">
                    <i class="fas fa-calendar-check"></i> 考勤记录
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="sheet_music.html">
                    <i class="fas fa-file-alt"></i> 在线曲谱
                </a>
            </li>
            <li class="nav-item mt-5">
                <a class="nav-link" href="../login.html">
                    <i class="fas fa-sign-out-alt"></i> 退出登录
                </a>
            </li>
        </ul>
    </div>

    <!-- 主要内容 -->
    <div class="main-content">
        <div class="container-fluid">
            <!-- 顶部导航 -->
            <nav class="navbar navbar-expand-lg navbar-light bg-white rounded-3 shadow-sm mb-4">
                <div class="container-fluid">
                    <span class="navbar-brand mb-0 h1">今日练琴</span>
                    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                        <span class="navbar-toggler-icon"></span>
                    </button>
                    <div class="collapse navbar-collapse" id="navbarNav">
                        <ul class="navbar-nav ms-auto">
                            <li class="nav-item">
                                <a class="nav-link" href="#">
                                    <i class="fas fa-bell"></i>
                                    <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                                        {{ notifications_count|default:"0" }}
                                    </span>
                                </a>
                            </li>
                            <li class="nav-item dropdown">
                                <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown">
                                    {% if student.user.avatar %}
                                    <img src="{{ student.user.avatar.url }}" class="rounded-circle" width="30" height="30">
                                    {% else %}
                                    <img src="{% static 'img/default-avatar.jpg' %}" class="rounded-circle" width="30" height="30">
                                    {% endif %}
                                    <span class="ms-1">{{ student.name }}</span>
                                </a>
                                <ul class="dropdown-menu dropdown-menu-end">
                                    <li><a class="dropdown-item" href="{% url 'students:profile' %}"><i class="fas fa-user me-2"></i>个人资料</a></li>
                                    <li><a class="dropdown-item" href="{% url 'students:profile' %}"><i class="fas fa-cog me-2"></i>账号设置</a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item" href="{% url 'logout' %}"><i class="fas fa-sign-out-alt me-2"></i>退出登录</a></li>
                                </ul>
                            </li>
                        </ul>
                    </div>
                </div>
            </nav>

            <!-- 练琴卡片 -->
            <div class="practice-card">
                <!-- 添加隐藏的数据元素 -->
                <div id="today-practice-data" style="display: none;">
                    {% if today_practice %}
                        {
                            "start_time": "{{ today_practice.start_time|time:'H:i' }}",
                            "start_time_full": "{{ today_practice.start_time|date:'Y-m-d H:i:s' }}",
                            "piano_number": {{ today_practice.piano_number }},
                            "waiting": {% if today_practice.start_time > current_time %}true{% else %}false{% endif %}
                        }
                    {% else %}
                        null
                    {% endif %}
                </div>
                
                <div class="practice-header">
                    <h2>今日练琴</h2>
                    <p>{{ today|date:"Y年n月j日" }} {{ today|date:"l"|stringformat:"s"|cut:"day"|cut:"Sun"|cut:"Mon"|cut:"Tues"|cut:"Wednes"|cut:"Thurs"|cut:"Fri"|cut:"Satur" }}日</p>
                </div>
                
                <!-- 练琴状态 -->
                <div class="practice-status {% if today_practice %}{% if today_practice.end_time > current_time %}active{% elif today_practice.start_time > current_time %}waiting{% else %}completed{% endif %}{% else %}inactive{% endif %}" id="practiceStatus">
                    <div class="status-icon">
                        {% if today_practice %}
                            {% if today_practice.end_time > current_time and today_practice.start_time <= current_time %}
                                <i class="fas fa-music"></i>
                            {% elif today_practice.start_time > current_time %}
                                <i class="fas fa-hourglass-half"></i>
                            {% else %}
                                <i class="fas fa-check-circle"></i>
                            {% endif %}
                        {% else %}
                            <i class="fas fa-hourglass-start"></i>
                        {% endif %}
                    </div>
                    <div class="status-text">
                        {% if today_practice %}
                            {% if today_practice.end_time > current_time and today_practice.start_time <= current_time %}
                                练琴中
                            {% elif today_practice.start_time > current_time %}
                                等待中
                            {% else %}
                                已完成
                            {% endif %}
                        {% else %}
                            未开始练琴
                        {% endif %}
                    </div>
                    <div class="status-desc">
                        {% if today_practice %}
                            {% if today_practice.end_time > current_time and today_practice.start_time <= current_time %}
                                使用 {{ today_practice.piano_number }} 号钢琴，开始时间：{{ today_practice.start_time|time:"H:i" }}
                            {% elif today_practice.start_time > current_time %}
                                您预约的钢琴是 {{ today_practice.piano_number }} 号，预计开始时间：{{ today_practice.start_time|time:"H:i" }}
                            {% else %}
                                今日练琴时长：{{ today_practice.duration }} 分钟
                            {% endif %}
                        {% else %}
                            请扫描二维码或点击签到按钮开始练琴
                        {% endif %}
                    </div>
                </div>
                
                <!-- 显示等待信息 -->
                <div class="waiting-info" id="waitingInfo" {% if today_practice and today_practice.start_time > current_time %}style="display: block;"{% else %}style="display: none;"{% endif %}>
                    <i class="fas fa-clock"></i>
                    <span>您已加入排队队列，预计等待时间：</span>
                    <span class="waiting-time" id="waitingTime">
                        {% if estimated_wait_time %}{{ estimated_wait_time }}分钟{% else %}计算中...{% endif %}
                    </span>
                </div>
                
                <!-- 显示当前练习时长计时器 -->
                <div class="timer-container" id="timerContainer" {% if today_practice and today_practice.end_time > current_time and today_practice.start_time <= current_time %}style="display: block;"{% else %}style="display: none;"{% endif %}>
                    <div class="timer" id="practiceTimer">
                        <span id="hours">00</span>:<span id="minutes">00</span>:<span id="seconds">00</span>
                    </div>
                    <div class="timer-label">练琴时长</div>
                </div>
                
                <!-- 二维码扫描区域 -->
                <div class="qr-scanner" id="qrScanner">
                    <div class="qr-scanner-overlay">
                        <video id="qrVideo"></video>
                        <div class="qr-scanner-frame"></div>
                    </div>
                    <div class="qr-scanner-controls">
                        <button class="btn btn-secondary" id="closeScanner">
                            <i class="fas fa-times"></i> 关闭扫描
                        </button>
                    </div>
                </div>
                
                <!-- 操作按钮 -->
                <div class="action-buttons">
                    <button id="checkinBtn" class="btn btn-primary btn-action btn-checkin" 
                        {% if today_practice %}disabled{% endif %}>
                        <i class="fas fa-sign-in-alt"></i> 签到
                    </button>
                    <button id="scanBtn" class="btn btn-success btn-action btn-scan">
                        <i class="fas fa-qrcode"></i> 扫码签到
                    </button>
                    <button id="checkoutBtn" class="btn btn-danger btn-action btn-checkout"
                        {% if not today_practice or today_practice.end_time < current_time %}disabled{% endif %}>
                        <i class="fas fa-sign-out-alt"></i> 签退
                    </button>
                </div>
                
                <!-- 钢琴信息 -->
                <div class="piano-info" id="pianoInfo" {% if today_practice and today_practice.end_time > current_time and today_practice.start_time <= current_time %}style="display: block;"{% else %}style="display: none;"{% endif %}>
                    <h4><i class="fas fa-piano"></i> 分配的钢琴信息</h4>
                    <div class="piano-details">
                        <div class="piano-detail-item">
                            <div class="piano-detail-label">钢琴编号</div>
                            <div class="piano-detail-value">{{ today_practice.piano_number|default:"--" }}</div>
                        </div>
                        <div class="piano-detail-item">
                            <div class="piano-detail-label">钢琴品牌</div>
                            <div class="piano-detail-value">{{ piano_brand|default:"雅马哈 (Yamaha)" }}</div>
                        </div>
                        <div class="piano-detail-item">
                            <div class="piano-detail-label">型号</div>
                            <div class="piano-detail-value">{{ piano_model|default:"YDP-164" }}</div>
                        </div>
                        <div class="piano-detail-item">
                            <div class="piano-detail-label">位置</div>
                            <div class="piano-detail-value">1楼 练习室{{ today_practice.piano_number|default:"--" }}</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 练琴提示 -->
            <div class="practice-card">
                <h4 class="mb-4"><i class="fas fa-lightbulb me-2 text-warning"></i>练琴小贴士</h4>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <div class="card h-100 border-0 shadow-sm">
                            <div class="card-body">
                                <h5 class="card-title"><i class="fas fa-clock me-2 text-primary"></i>合理安排时间</h5>
                                <p class="card-text">每天保持30-60分钟的练习时间，比偶尔长时间练习效果更好。保持规律性是提高技能的关键。</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <div class="card h-100 border-0 shadow-sm">
                            <div class="card-body">
                                <h5 class="card-title"><i class="fas fa-hand-paper me-2 text-success"></i>注意手部姿势</h5>
                                <p class="card-text">保持正确的手部姿势，手腕放松，手指自然弯曲。避免长时间练习导致的疲劳和紧张。</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <div class="card h-100 border-0 shadow-sm">
                            <div class="card-body">
                                <h5 class="card-title"><i class="fas fa-music me-2 text-danger"></i>分段练习</h5>
                                <p class="card-text">将曲目分成小段落进行练习，掌握一个段落后再进行下一个，最后将它们连接起来。</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <div class="card h-100 border-0 shadow-sm">
                            <div class="card-body">
                                <h5 class="card-title"><i class="fas fa-heartbeat me-2 text-info"></i>用心聆听</h5>
                                <p class="card-text">练习时专注于聆听自己的演奏，注意音色、节奏和表现力，培养音乐感和表现力。</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../static/js/skin/default/layer.js"></script>
    <!-- QR Scanner JS -->
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <script>
        // 获取CSRF Token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // 签到功能
        const checkIn = () => {
            fetch('/students/check-in/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    if (data.practice_time) {
                        // 显示练琴时间
                        showPracticeTime(data.practice_time, data.piano_number);
                    } else if (data.wait_time) {
                        // 显示等待时间
                        showWaitTime(data.wait_time);
                    }
                    layer.msg(data.message);
                } else {
                    layer.msg(data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                layer.msg('操作失败，请重试');
            });
        };

        // 签退功能
        const checkOut = () => {
            fetch('/students/check-out/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // 更新界面状态
                    updateCheckoutStatus();
                    layer.msg(data.message);
                } else {
                    layer.msg(data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                layer.msg('操作失败，请重试');
            });
        };

        // 显示练琴时间
        const showPracticeTime = (practiceTime, pianoNumber) => {
            const practiceStatus = document.querySelector('.practice-status');
            practiceStatus.classList.remove('inactive');
            practiceStatus.classList.add('active');
            
            const statusText = practiceStatus.querySelector('.status-text');
            statusText.textContent = `练琴时间：${practiceTime}`;
            
            const statusDesc = practiceStatus.querySelector('.status-desc');
            statusDesc.textContent = `钢琴编号：${pianoNumber}`;
            
            // 隐藏签到按钮，显示签退按钮
            document.querySelector('.btn-checkin').style.display = 'none';
            document.querySelector('.btn-checkout').style.display = 'flex';
        };

        // 显示等待时间
        const showWaitTime = (waitTime) => {
            const practiceStatus = document.querySelector('.practice-status');
            practiceStatus.classList.remove('active');
            practiceStatus.classList.add('inactive');
            
            const statusText = practiceStatus.querySelector('.status-text');
            statusText.textContent = `等待时间：${waitTime}分钟`;
            
            const statusDesc = practiceStatus.querySelector('.status-desc');
            statusDesc.textContent = '请耐心等待，系统会自动为您安排练琴时间';
            
            // 隐藏签到按钮
            document.querySelector('.btn-checkin').style.display = 'none';
        };

        // 更新签退状态
        const updateCheckoutStatus = () => {
            const practiceStatus = document.querySelector('.practice-status');
            practiceStatus.classList.remove('active');
            practiceStatus.classList.add('inactive');
            
            const statusText = practiceStatus.querySelector('.status-text');
            statusText.textContent = '今日练琴已完成';
            
            const statusDesc = practiceStatus.querySelector('.status-desc');
            statusDesc.textContent = '感谢您的练习，明天见！';
            
            // 隐藏签退按钮
            document.querySelector('.btn-checkout').style.display = 'none';
        };

        // 页面加载时检查状态
        document.addEventListener('DOMContentLoaded', () => {
            // 从后端传递的数据中获取练琴信息
            const todayPractice = JSON.parse(document.getElementById('today-practice-data').textContent);
            if (todayPractice) {
                showPracticeTime(todayPractice.start_time, todayPractice.piano_number);
            }
        });

        $(document).ready(function() {
            // 签到按钮事件
            $("#checkinBtn").click(function() {
                $.ajax({
                    url: "{% url 'students:check_in' %}",
                    type: "POST",
                    data: {
                        csrfmiddlewaretoken: "{{ csrf_token }}"
                    },
                    success: function(response) {
                        if (response.success) {
                            Swal.fire({
                                icon: 'success',
                                title: '签到成功',
                                text: response.message,
                                timer: 2000
                            }).then(function() {
                                location.reload();
                            });
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: '签到失败',
                                text: response.message
                            });
                        }
                    },
                    error: function(xhr) {
                        Swal.fire({
                            icon: 'error',
                            title: '操作失败',
                            text: '请求出错，请稍后重试'
                        });
                    }
                });
            });
            
            // 签退按钮事件
            $("#checkoutBtn").click(function() {
                $.ajax({
                    url: "{% url 'students:check_out' %}",
                    type: "POST",
                    data: {
                        csrfmiddlewaretoken: "{{ csrf_token }}"
                    },
                    success: function(response) {
                        if (response.success) {
                            Swal.fire({
                                icon: 'success',
                                title: '签退成功',
                                text: response.message,
                                timer: 2000
                            }).then(function() {
                                location.reload();
                            });
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: '签退失败',
                                text: response.message
                            });
                        }
                    },
                    error: function(xhr) {
                        Swal.fire({
                            icon: 'error',
                            title: '操作失败',
                            text: '请求出错，请稍后重试'
                        });
                    }
                });
            });

            // 二维码扫描
            let video = document.getElementById('scanner');
            let scanActive = false;
            let scanInterval;

            $("#scanBtn").click(function() {
                $('#qrScanModal').modal('show');
                startScanner();
            });

            // 关闭模态框时停止扫描
            $('#qrScanModal').on('hidden.bs.modal', function() {
                stopScanner();
            });

            function startScanner() {
                if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                    scanActive = true;
                    navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
                        .then(function(stream) {
                            video.srcObject = stream;
                            video.setAttribute('playsinline', true);
                            video.play();
                            scanInterval = setInterval(scanQRCode, 1000);
                        })
                        .catch(function(error) {
                            console.error('无法访问摄像头:', error);
                            $('#scanResult').removeClass('d-none').addClass('alert-danger').text('无法访问摄像头，请确保已授予摄像头权限。');
                        });
                } else {
                    $('#scanResult').removeClass('d-none').addClass('alert-danger').text('您的浏览器不支持摄像头访问。');
                }
            }

            function stopScanner() {
                scanActive = false;
                clearInterval(scanInterval);
                if (video.srcObject) {
                    video.srcObject.getTracks().forEach(track => track.stop());
                }
            }

            function scanQRCode() {
                if (!scanActive) return;
                
                let canvas = document.createElement('canvas');
                let context = canvas.getContext('2d');
                if (video.videoWidth > 0 && video.videoHeight > 0) {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    context.drawImage(video, 0, 0, canvas.width, canvas.height);
                    let imageData = context.getImageData(0, 0, canvas.width, canvas.height);
                    
                    let code = jsQR(imageData.data, imageData.width, imageData.height, {
                        inversionAttempts: "dontInvert",
                    });
                    
                    if (code) {
                        // 停止扫描
                        stopScanner();
                        
                        // 显示扫描结果
                        $('#scanResult').removeClass('d-none').addClass('alert-info').text('正在处理二维码数据...');
                        
                        // 发送到后端
                        $.ajax({
                            url: "{% url 'students:scan_qrcode' %}",
                            type: "POST",
                            data: {
                                csrfmiddlewaretoken: "{{ csrf_token }}",
                                qrcode_data: code.data
                            },
                            success: function(response) {
                                if (response.success) {
                                    $('#qrScanModal').modal('hide');
                                    Swal.fire({
                                        icon: 'success',
                                        title: '扫码成功',
                                        text: response.message,
                                        timer: 2000
                                    }).then(function() {
                                        location.reload();
                                    });
                                } else {
                                    $('#scanResult').removeClass('alert-info').addClass('alert-danger').text(response.message);
                                    
                                    // 3秒后重新启动扫描
                                    setTimeout(function() {
                                        $('#scanResult').removeClass('alert-danger').addClass('alert-info').text('请将二维码对准摄像头...');
                                        startScanner();
                                    }, 3000);
                                }
                            },
                            error: function() {
                                $('#scanResult').removeClass('alert-info').addClass('alert-danger').text('请求出错，请稍后重试');
                                
                                // 3秒后重新启动扫描
                                setTimeout(function() {
                                    $('#scanResult').removeClass('alert-danger').addClass('alert-info').text('请将二维码对准摄像头...');
                                    startScanner();
                                }, 3000);
                            }
                        });
                    }
                }
            }

            // 倒计时功能
            let countdownInterval;
            let targetTime;
            
            // 将模板条件判断移出JavaScript
            function initCountdown() {
                const todayPracticeData = document.getElementById('today-practice-data').textContent;
                if (todayPracticeData && todayPracticeData.trim() !== 'null') {
                    const practiceData = JSON.parse(todayPracticeData);
                    // 检查start_time是否大于当前时间
                    const startTime = new Date(practiceData.start_time_full).getTime();
                    const now = new Date().getTime();
                    
                    if (startTime > now) {
                        // 学生在等待中
                        targetTime = startTime;
                        
                        // 初始化倒计时
                        updateCountdown();
                        countdownInterval = setInterval(updateCountdown, 1000);
                    }
                }
            }
            
            function updateCountdown() {
                if (!targetTime) return;
                
                let now = new Date().getTime();
                let distance = targetTime - now;
                
                if (distance <= 0) {
                    // 已到练琴时间
                    clearInterval(countdownInterval);
                    $('#countdownModal').modal('show');
                    $('#countdownMessage').text('现在是你的练琴时间!');
                    $('#countdownMinutes').text('00');
                    $('#countdownSeconds').text('00');
                    
                    // 从隐藏数据中获取钢琴编号
                    const todayPracticeData = document.getElementById('today-practice-data').textContent;
                    if (todayPracticeData && todayPracticeData.trim() !== 'null') {
                        const practiceData = JSON.parse(todayPracticeData);
                        $('#pianoNumber').text(practiceData.piano_number);
                    } else {
                        $('#pianoNumber').text('-');
                    }
                    
                    // 自动刷新页面
                    setTimeout(function() {
                        location.reload();
                    }, 3000);
                    return;
                }
                
                // 计算并显示分钟和秒
                let minutes = Math.floor(distance / (1000 * 60));
                let seconds = Math.floor((distance % (1000 * 60)) / 1000);
                
                // 更新显示
                $('.waiting-time').text(minutes + ' 分钟 ' + seconds + ' 秒');
                
                // 当剩余时间少于5分钟时，显示倒计时模态框
                if (minutes < 5 && !$('#countdownModal').hasClass('show')) {
                    $('#countdownModal').modal('show');
                    let modalCountdown = setInterval(function() {
                        let now = new Date().getTime();
                        let modalDistance = targetTime - now;
                        
                        if (modalDistance <= 0) {
                            clearInterval(modalCountdown);
                            $('#countdownMessage').text('现在是你的练琴时间!');
                            $('#countdownMinutes').text('00');
                            $('#countdownSeconds').text('00');
                            return;
                        }
                        
                        let modalMinutes = Math.floor(modalDistance / (1000 * 60));
                        let modalSeconds = Math.floor((modalDistance % (1000 * 60)) / 1000);
                        
                        $('#countdownMinutes').text(modalMinutes < 10 ? '0' + modalMinutes : modalMinutes);
                        $('#countdownSeconds').text(modalSeconds < 10 ? '0' + modalSeconds : modalSeconds);
                        
                        // 从隐藏数据中获取钢琴编号
                        const todayPracticeData = document.getElementById('today-practice-data').textContent;
                        if (todayPracticeData && todayPracticeData.trim() !== 'null') {
                            const practiceData = JSON.parse(todayPracticeData);
                            $('#pianoNumber').text(practiceData.piano_number);
                        } else {
                            $('#pianoNumber').text('-');
                        }
                    }, 1000);
                    
                    // 模态框关闭时清除模态框倒计时
                    $('#countdownModal').on('hidden.bs.modal', function() {
                        clearInterval(modalCountdown);
                    });
                }
            }
            
            // 初始化倒计时
            initCountdown();

            // 定期检查练琴状态
            function checkPracticeStatus() {
                $.get("{% url 'students:practice_status' %}", function(data) {
                    // 根据状态更新界面
                    if (data.status === 'waiting') {
                        // 更新等待状态
                        $('.practice-status')
                            .removeClass('inactive active')
                            .addClass('waiting');
                        $('.status-icon').html('<i class="fas fa-hourglass-half"></i>');
                        $('.status-text').text('等待中');
                        $('.status-desc').text('您排在第 ' + (data.position || '-') + ' 位，预计等待时间 ' + (data.wait_minutes || '-') + ' 分钟');
                    } else if (data.status === 'active') {
                        // 更新练琴中状态
                        $('.practice-status')
                            .removeClass('inactive waiting')
                            .addClass('active');
                        $('.status-icon').html('<i class="fas fa-music"></i>');
                        $('.status-text').text('练琴中');
                        $('.status-desc').text('使用 ' + data.piano_number + ' 号钢琴，已练习 ' + (data.elapsed_minutes || 0) + ' 分钟');
                        
                        // 启用签退按钮
                        $('#checkoutBtn').prop('disabled', false);
                        // 禁用签到和扫码按钮
                        $('#checkinBtn, #scanBtn').prop('disabled', true);
                    } else if (data.status === 'completed') {
                        // 更新已完成状态
                        $('.practice-status')
                            .removeClass('active waiting')
                            .addClass('completed');
                        $('.status-icon').html('<i class="fas fa-check-circle"></i>');
                        $('.status-text').text('已完成');
                        $('.status-desc').text(`今日练琴时长：${data.duration || 0} 分钟`);
                        
                        // 禁用所有按钮
                        $('#checkinBtn, #scanBtn, #checkoutBtn').prop('disabled', true);
                    } else {
                        // 默认未开始状态
                        $('.practice-status')
                            .removeClass('active waiting completed')
                            .addClass('inactive');
                        $('.status-icon').html('<i class="fas fa-clock"></i>');
                        $('.status-text').text('未开始');
                        $('.status-desc').text('请点击"签到"或"扫码签到"开始今日练琴');
                        
                        // 启用签到和扫码按钮
                        $('#checkinBtn, #scanBtn').prop('disabled', false);
                        // 禁用签退按钮
                        $('#checkoutBtn').prop('disabled', true);
                    }
                });
            }
            
            // 页面加载后检查状态，然后每60秒检查一次
            checkPracticeStatus();
            setInterval(checkPracticeStatus, 60000);
        });

        // 练琴时长计时器
        function initPracticeTimer() {
            const todayPracticeData = document.getElementById('today-practice-data').textContent;
            if (todayPracticeData && todayPracticeData.trim() !== 'null') {
                const practiceData = JSON.parse(todayPracticeData);
                const startTimeStr = practiceData.start_time_full;
                
                if (startTimeStr) {
                    const startTime = new Date(startTimeStr);
                    const now = new Date();
                    
                    // 如果已经开始练琴但未结束
                    if (startTime <= now && document.getElementById('timerContainer').style.display !== 'none') {
                        // 计算已练习时间（毫秒）
                        let elapsedTime = now - startTime;
                        
                        // 更新计时器显示
                        function updateTimer() {
                            // 增加已经练习的时间
                            elapsedTime += 1000;
                            
                            // 计算小时、分钟和秒
                            const hours = Math.floor(elapsedTime / (1000 * 60 * 60));
                            const minutes = Math.floor((elapsedTime % (1000 * 60 * 60)) / (1000 * 60));
                            const seconds = Math.floor((elapsedTime % (1000 * 60)) / 1000);
                            
                            // 更新显示
                            document.getElementById('hours').textContent = hours < 10 ? '0' + hours : hours;
                            document.getElementById('minutes').textContent = minutes < 10 ? '0' + minutes : minutes;
                            document.getElementById('seconds').textContent = seconds < 10 ? '0' + seconds : seconds;
                        }
                        
                        // 初始更新
                        updateTimer();
                        
                        // 每秒更新一次
                        setInterval(updateTimer, 1000);
                    }
                }
            }
        }
        
        // 页面加载时初始化计时器
        document.addEventListener('DOMContentLoaded', function() {
            initPracticeTimer();
        });
    </script>

    <!-- QR码扫描模态框 -->
    <div class="modal fade" id="qrScanModal" tabindex="-1" aria-labelledby="qrScanModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="qrScanModalLabel">扫描二维码签到</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <div class="scanner-container mb-3" style="position: relative; width: 100%; height: 0; padding-bottom: 75%;">
                        <video id="scanner" style="position: absolute; width: 100%; height: 100%; object-fit: cover; border-radius: 10px;"></video>
                        <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 2px dashed #6c5ce7; border-radius: 10px; pointer-events: none;"></div>
                    </div>
                    <div id="scanResult" class="alert alert-info">
                        请将二维码对准摄像头...
                    </div>
                    <p class="text-muted"><small>支持扫描教师生成的练琴考勤二维码</small></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 倒计时提醒模态框 -->
    <div class="modal fade" id="countdownModal" tabindex="-1" aria-labelledby="countdownModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="countdownModalLabel">练琴提醒</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <div class="countdown-container">
                        <h3 id="countdownMessage">快到你练琴的时间了！</h3>
                        <div class="countdown-timer">
                            <span id="countdownMinutes">00</span>:<span id="countdownSeconds">00</span>
                        </div>
                        <p>钢琴编号: <strong id="pianoNumber">-</strong></p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">我知道了</button>
                </div>
            </div>
        </div>
    </div>
</body>
</html> 